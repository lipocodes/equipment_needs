<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>רשימת ציוד נדרש</title>
<style>
  body {
    font-family: "Segoe UI", Roboto, Arial, sans-serif;
    background-color: #f8fafc;
    color: #333;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    min-height: 100vh;
    margin: 0;
    box-sizing: border-box;
  }

  .page-title {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    font-size: 2rem;
    font-weight: 650;
    color: #1d3557;
    background: linear-gradient(to right, #ffffff, #f7f9fb);
    padding: 25px 15px;
    margin: 0 0 20px 0;
    border-bottom: 4px solid #0057b8;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
    gap: 15px;
  }

  #search-box {
    width: 90%;
    max-width: 600px;
    padding: 8px 10px;
    font-size: 1rem;
    margin-bottom: 20px;
    border-radius: 5px;
    border: 1px solid #aaa;
  }

  #add-item-btn {
    padding: 8px 15px;
    border-radius: 5px;
    border: none;
    color: #fff;
    cursor: pointer;
    font-size: 1rem;
    margin-bottom: 20px;
  }

  .equipment-item {
    border: 1px solid #ccc;
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 8px;
    width: 90%;
    max-width: 600px;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: space-between;
  }

  button {
    padding: 5px 10px;
    border-radius: 4px;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    color: #fff;
  }

  .order-btn {
    background-color: #1d3557;
  }

  .order-btn:hover {
    background-color: #457b9d;
  }

  .cancel-btn {
    background-color: #b80000;
  }

  .cancel-btn:hover {
    background-color: #e63946;
  }

  .quantity-display {
    min-width: 30px;
    text-align: center;
    font-weight: bold;
  }

  .order-summary {
    margin-top: 30px;
    width: 90%;
    max-width: 600px;
    background: #f1f3f5;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }

  .order-summary h3 {
    margin-top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .order-summary ul {
    padding-left: 20px;
  }

  dialog {
    padding:20px; 
    border-radius:10px; 
    border:1px solid #ccc;
  }

  dialog input {
    width: 100%;
    padding: 5px;
    margin-bottom: 10px;
  }

  dialog button {
    padding: 5px 10px;
  }
</style>
</head>
<body>

<h1 class="page-title">YVC Library - Equipment Needs</h1>

<input type="text" id="search-box" placeholder="חפש ציוד..." oninput="filterEquipment()">

<!-- Button to open dialog -->
<button id="add-item-btn" style="background-color:#1d3557;">➕ הוסף ציוד חדש</button>

<!-- Dialog for adding a new item -->
<dialog id="add-item-dialog">
  <h3>הוסף ציוד חדש</h3>
  <input type="text" id="new-item-name" placeholder="שם הציוד">
  <div style="display:flex; justify-content:flex-end; gap:10px;">
    <button onclick="submitNewItem()" style="background-color:#1d3557;">הוסף</button>
    <button onclick="closeAddDialog()" style="background-color:#b80000;">ביטול</button>
  </div>
</dialog>

<div id="equipment-container"></div>

<div class="order-summary">
  <h3>
    סיכום הזמנה
    <button id="download-txt-btn" style="background-color:#1d3557; font-size:0.9rem;">⬇ הורד TXT</button>
  </h3>
  <ul id="order-list">
    <li>לא נבחר ציוד עדיין</li>
  </ul>
</div>

<script>
let office_equipment = [];
const MAX_QUANTITY = 10;
const equipmentContainer = document.getElementById("equipment-container");
const orderList = document.getElementById("order-list");

// Fetch equipment data from backend JSON
async function loadEquipment() {
  try {
    const res = await fetch("/get_equipment");
    const data = await res.json();
    office_equipment = data.office_equipment;

    renderEquipment();
    renderOrderSummary();
  } catch (err) {
    console.error("Failed to load equipment:", err);
  }
}

// Render equipment items sorted by Hebrew alphabet
function renderEquipment(filter = "") {
  equipmentContainer.innerHTML = "";

  const filtered = office_equipment
    .filter(item => item.item.includes(filter))
    .sort((a, b) => a.item.localeCompare(b.item, 'he'));

  filtered.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "equipment-item";

    div.innerHTML = `
      <span>${item.item}</span>
      <div>
        <button class="order-btn" onclick="incrementOrder(${index})">+</button>
        <button class="cancel-btn" onclick="decrementOrder(${index})">-</button>
        <button onclick="cancelOrder(${index})" style="background:none;">❌</button>
        <span class="quantity-display" id="quantity-display-${index}">${item.quantity}</span>
      </div>
    `;

    equipmentContainer.appendChild(div);
  });
}

async function cancelOrder(index) {
  const item = office_equipment[index];

  await fetch("/cancel_equipment_orders", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ item: item.item })
  });

  loadEquipment();
}

async function incrementOrder(index) {
  const item = office_equipment[index];
  if (item.quantity < MAX_QUANTITY) {
    item.quantity += 1;
    document.getElementById(`quantity-display-${index}`).textContent = item.quantity;
    renderOrderSummary();

    await fetch("/increment_equipment_orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ item: item.item })
    });
  }
}

async function decrementOrder(index) {
  const item = office_equipment[index];
  if (item.quantity > 0) {
    item.quantity -= 1;
    document.getElementById(`quantity-display-${index}`).textContent = item.quantity;
    renderOrderSummary();

    await fetch("/decrement_equipment_orders", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ item: item.item })
    });
  }
}

// Render order summary sorted by Hebrew alphabet
function renderOrderSummary() {
  const orders = office_equipment
    .filter(item => item.quantity > 0)
    .sort((a, b) => a.item.localeCompare(b.item, 'he'))
    .map(item => `<li>${item.item} - כמות: ${item.quantity}</li>`);

  orderList.innerHTML = orders.length > 0 ? orders.join('') : '<li>לא נבחר ציוד עדיין</li>';
}

function filterEquipment() {
  const filterValue = document.getElementById("search-box").value.trim();
  renderEquipment(filterValue);
}

// Initial fetch + render
loadEquipment();

// --- Add Item Dialog ---
const addItemBtn = document.getElementById("add-item-btn");
const addItemDialog = document.getElementById("add-item-dialog");

addItemBtn.addEventListener("click", () => {
  addItemDialog.showModal();
});

function closeAddDialog() {
  addItemDialog.close();
}

async function submitNewItem() {
  const name = document.getElementById("new-item-name").value.trim();

  if (!name) {
    alert("אנא הכנס שם ציוד");
    return;
  }

  try {
    const res = await fetch("/add_item", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ item: name, quantity: 0 })
    });

    const data = await res.json();
    if (res.ok) {
      alert("ציוד נוסף בהצלחה!");
      closeAddDialog();
      loadEquipment();
    } else {
      alert(data.message || "שגיאה בהוספת ציוד");
    }
  } catch (err) {
    console.error(err);
    alert("שגיאה בשרת");
  }
}

// --- Download TXT Functionality ---
document.getElementById("download-txt-btn").addEventListener("click", () => {
  const orders = office_equipment
    .filter(item => item.quantity > 0)
    .sort((a, b) => a.item.localeCompare(b.item, 'he'));

  if (orders.length === 0) {
    alert("לא נבחר ציוד עדיין");
    return;
  }

  let textContent = "סיכום הזמנה - YVC Library\n\n";
  orders.forEach(item => {
    textContent += `${item.item} - כמות: ${item.quantity}\n`;
  });

  const blob = new Blob([textContent], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "order.txt";
  a.click();
  URL.revokeObjectURL(url);
});
</script>

</body>
</html>
